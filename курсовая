#include <iostream>
#include <iomanip>
#include <string>
#include <limits>
#include <locale>
#include <vector> 


using namespace std;

struct TestCase {
    string название;
    double выручка;
    double расходы;
    double ФОТ;
    string система;
    double ожидаемый_налог;
    double ожидаемая_прибыль;
    double ожидаемая_нагрузка;
};

// отображение главного меню
int показать_меню() {
    cout << "КАЛЬКУЛЯТОР НАЛОГОВОЙ НАГРУЗКИ \n";
    cout << "1. Ввести данные и рассчитать\n";
    cout << "2. Показать справку по системам налогообложения\n";
    cout << "3. О программе\n";
    cout << "4. Запустить тесты\n";
    cout << "5. Выход\n";
    cout << "Выберите пункт меню (1-5): ";

    return 0;
}

// отображение справки
void показать_справку() {
    cout << "СПРАВКА ПО СИСТЕМАМ НАЛОГООБЛОЖЕНИЯ \n";
    cout << "1. ОСНО (Общая система налогообложения):\n";
    cout << "   - Налог на прибыль: 20% от (выручка - расходы - ФОТ)\n";
    cout << "   - Подходит для крупного бизнеса\n\n";

    cout << "2. УСН 6% (Упрощённая система, доходы):\n";
    cout << "   - Налог: 6% от выручки\n";
    cout << "   - Расходы не учитываются\n\n";

    cout << "3. УСН 15% (Упрощённая система, доходы-расходы):\n";
    cout << "   - Налог: 15% от (выручка - расходы)\n";
    cout << "   - ФОТ не вычитается из налоговой базы\n";
    cout << "\nДля продолжения нажмите Enter...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cin.get();
}

// отображение информации о программе
void показать_о_программе() {
    cout << "О ПРОГРАММЕ \n";
    cout << "Калькулятор налоговой нагрузки v1.0\n";
    cout << "Программа рассчитывает налоговую нагрузку\n";
    cout << "для разных систем налогообложения\n";
    cout << "Для продолжения нажмите Enter...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cin.get();
}

// для расчёта налога
void рассчитать_налог(double выручка, double расходы, double ФОТ, string система_налогообложения,
    double& налог_результат, double& чистая_прибыль_результат, double& налоговая_нагрузка_результат) {
    // расчёт налога
    налог_результат = 0;

    if (система_налогообложения == "ОСНО" || система_налогообложения == "осно") {
        налог_результат = (выручка - расходы - ФОТ) * 0.20;
    }
    else if (система_налогообложения == "УСН_6" || система_налогообложения == "усн6") {
        налог_результат = выручка * 0.06;
    }
    else if (система_налогообложения == "УСН_15" || система_налогообложения == "усн15") {
        налог_результат = (выручка - расходы) * 0.15;
    }

    // расчёт чистой прибыли и налоговой нагрузки
    чистая_прибыль_результат = выручка - расходы - ФОТ - налог_результат;
    налоговая_нагрузка_результат = (выручка == 0) ? 0 : (налог_результат / выручка) * 100;
}

// ввод данных и расчёт 
void рассчитать_налог_интерфейс() {
    double выручка, расходы, ФОТ;
    string система_налогообложения;

    cout << "ВВОД ДАННЫХ ДЛЯ РАСЧЁТА \n";

    // ввод выручки с проверкой
    while (true) {
        cout << "Введите выручку: ";
        cin >> выручка;

        if (cin.fail() || выручка < 0) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Ошибка: введите корректное число!\n";
        }
        else {
            break;
        }
    }

    // ввод расходов с проверкой
    while (true) {
        cout << "Введите расходы (от 0 до " << выручка << "): ";
        cin >> расходы;

        if (cin.fail() || расходы < 0 || расходы > выручка) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Ошибка: расходы должны быть от 0 до " << выручка << "!\n";
        }
        else {
            break;
        }
    }

    // ввод ФОТ с проверкой
    while (true) {
        cout << "Введите фонд оплаты труда: ";
        cin >> ФОТ;

        if (cin.fail() || ФОТ < 0) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Ошибка: введите корректное число!\n";
        }
        else {
            break;
        }
    }

    // ввод системы налогообложения с проверкой
    while (true) {
        cout << "\nВыберите систему налогообложения:\n";
        cout << "1. ОСНО (Общая система)\n";
        cout << "2. УСН 6% (Доходы)\n";
        cout << "3. УСН 15% (Доходы минус расходы)\n";
        cout << "Ваш выбор (1-3): ";

        int выбор_системы;
        cin >> выбор_системы;

        if (cin.fail() || выбор_системы < 1 || выбор_системы > 3) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Ошибка: введите число от 1 до 3!\n";
        }
        else {
            switch (выбор_системы) {
            case 1: система_налогообложения = "ОСНО"; break;
            case 2: система_налогообложения = "УСН_6"; break;
            case 3: система_налогообложения = "УСН_15"; break;
            }
            break;
        }
    }

    // расчёт
    double налог_результат, чистая_прибыль_результат, налоговая_нагрузка_результат;
    рассчитать_налог(выручка, расходы, ФОТ, система_налогообложения,
        налог_результат, чистая_прибыль_результат, налоговая_нагрузка_результат);

    // вывод результатов
    cout << fixed << setprecision(2);
    cout << "РЕЗУЛЬТАТЫ РАСЧЁТА \n";
    cout << "Система налогообложения: " << система_налогообложения << endl;
    cout << "Выручка: " << выручка << " руб.\n";
    cout << "Расходы: " << расходы << " руб.\n";
    cout << "ФОТ: " << ФОТ << " руб.\n";
    cout << "Налог на прибыль: " << налог_результат << " руб.\n";
    cout << "Чистая прибыль: " << чистая_прибыль_результат << " руб.\n";
    cout << "Налоговая нагрузка: " << налоговая_нагрузка_результат << "%\n";

    cout << "Для продолжения нажмите Enter...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cin.get();
}

// запуск тестов
void запуск_тестов() {
    cout << "ЗАПУСК ТЕСТОВ \n";
    cout << "Тестирование функции расчёта налогов...\n\n";

    // тестовые случаи
    vector<TestCase> тесты = {
        {"Малый бизнес УСН6", 100000, 40000, 30000, "УСН_6", 6000, 24000, 6.00},
        {"Малый бизнес УСН15", 100000, 40000, 30000, "УСН_15", 9000, 21000, 9.00},
        {"Малый бизнес ОСНО", 100000, 40000, 30000, "ОСНО", 6000, 24000, 6.00},
        {"Крупный бизнес УСН6", 1000000, 600000, 200000, "УСН_6", 60000, 140000, 6.00},
        {"Крупный бизнес УСН15", 1000000, 600000, 200000, "УСН_15", 60000, 140000, 6.00},
        {"Крупный бизнес ОСНО", 1000000, 600000, 200000, "ОСНО", 40000, 160000, 4.00},
        {"Убыточный бизнес", 50000, 80000, 20000, "УСН_6", 3000, -53000, 6.00},
        {"Нулевая выручка", 0, 0, 0, "ОСНО", 0, 0, 0.00}
    };

    int пройдено_тестов = 0;
    int всего_тестов = тесты.size();

    // запуск каждого теста
    for (const auto& тест : тесты) {
        cout << "Тест: " << тест.название << endl;
        cout << "Входные данные: выручка=" << тест.выручка
            << ", расходы=" << тест.расходы
            << ", ФОТ=" << тест.ФОТ
            << ", система=" << тест.система << endl;

        double налог_результат, чистая_прибыль_результат, налоговая_нагрузка_результат;
        рассчитать_налог(тест.выручка, тест.расходы, тест.ФОТ, тест.система,
            налог_результат, чистая_прибыль_результат, налоговая_нагрузка_результат);

        bool налог_ок = fabs(налог_результат - тест.ожидаемый_налог) < 0.01;
        bool прибыль_ок = fabs(чистая_прибыль_результат - тест.ожидаемая_прибыль) < 0.01;
        bool нагрузка_ок = fabs(налоговая_нагрузка_результат - тест.ожидаемая_нагрузка) < 0.01;

        if (налог_ок && прибыль_ок && нагрузка_ок) {
            cout << "ПРОЙДЕН" << endl;
            пройдено_тестов++;
        }
        else {
            cout << "НЕ ПРОЙДЕН" << endl;
            cout << "  Ожидалось: налог=" << тест.ожидаемый_налог
                << ", прибыль=" << тест.ожидаемая_прибыль
                << ", нагрузка=" << тест.ожидаемая_нагрузка << "%" << endl;
            cout << "  Получено: налог=" << налог_результат
                << ", прибыль=" << чистая_прибыль_результат
                << ", нагрузка=" << налоговая_нагрузка_результат << "%" << endl;
        }

        // вывод расчёта
        cout << "  Расчёт: налог=" << налог_результат
            << ", чистая прибыль=" << чистая_прибыль_результат
            << ", налоговая нагрузка=" << налоговая_нагрузка_результат << "%" << endl;
        cout << string(50, '-') << endl;
    }

    // вывод итогов
    cout << "ИТОГИ ТЕСТИРОВАНИЯ \n";
    cout << "Пройдено тестов: " << пройдено_тестов << " из " << всего_тестов << endl;
    cout << "Успешность: " << fixed << setprecision(1)
        << (static_cast<double>(пройдено_тестов) / всего_тестов * 100) << "%" << endl;

    if (пройдено_тестов == всего_тестов) {
        cout << "Все тесты пройдены успешно\n";
    }
    else {
        cout << "Некоторые тесты не пройдены\n";
    }

    cout << "Для продолжения нажмите Enter...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cin.get();
}


int main() {
    setlocale(LC_ALL, "Russian");

    int выбор;
    bool программа_работает = true;

    while (программа_работает) {
        показать_меню();

        // считываем выбор пользователя
        cin >> выбор;

        if (cin.fail()) {
            cin.clear();
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cout << "Ошибка: введите число от 1 до 6!\n";
            cout << "Для продолжения нажмите Enter...";
            cin.get();
            continue;
        }

        // обработка выбора
        switch (выбор) {
        case 1:
            рассчитать_налог_интерфейс();
            break;

        case 2:
            показать_справку();
            break;

        case 3:
            показать_о_программе();
            break;

        case 4:
            запуск_тестов();
            break;

        case 5:
            cout << "Выход из программы...\n";
            программа_работает = false;
            break;

        default:
            cout << "Ошибка: введите число от 1 до 5!\n";
            cout << "Для продолжения нажмите Enter...";
            cin.ignore(numeric_limits<streamsize>::max(), '\n');
            cin.get();
            break;
        }
    }

    cout << "Нажмите Enter для выхода...";
    cin.ignore(numeric_limits<streamsize>::max(), '\n');
    cin.get();

    return 0;
}
